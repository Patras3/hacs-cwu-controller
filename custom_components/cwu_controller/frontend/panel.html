<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CWU Controller</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="stylesheet" href="styles.css?v=3.0.0">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-title">
                <div class="header-icon-wrapper">
                    <span class="mdi mdi-water-boiler"></span>
                    <div class="icon-pulse"></div>
                </div>
                <div>
                    <h1>CWU Controller</h1>
                    <p class="header-subtitle">Smart Heat Pump Management</p>
                </div>
            </div>
            <div class="header-status">
                <div class="status-badge" id="controller-status">
                    <span class="status-dot"></span>
                    <span class="status-text">Loading...</span>
                </div>
                <label class="toggle-switch" title="Enable/Disable Controller">
                    <input type="checkbox" id="controller-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
                <button class="btn btn-icon" onclick="refreshData()" title="Refresh Data">
                    <span class="mdi mdi-refresh"></span>
                </button>
            </div>
        </header>

        <!-- Alert for Fake Heating -->
        <div class="alert alert-danger animated" id="fake-heating-alert" style="display: none;">
            <span class="alert-icon mdi mdi-alert-circle mdi-spin"></span>
            <div>
                <strong>Fake Heating Detected!</strong>
                <p>Power is below 10W while water heater is active. The broken heater situation is detected.</p>
            </div>
            <button class="btn btn-sm" onclick="dismissAlert()">Dismiss</button>
        </div>

        <!-- Manual Override Alert -->
        <div class="alert alert-warning animated" id="override-alert" style="display: none;">
            <span class="alert-icon mdi mdi-hand-back-right"></span>
            <div>
                <strong>Manual Override Active</strong>
                <p>Automatic control is suspended. Override expires in: <span id="override-remaining">--</span></p>
            </div>
        </div>

        <!-- Main Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Current State Card - Full Width -->
            <div class="card state-card glass-effect">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-state-machine"></span>
                        Current State
                    </span>
                    <div class="state-indicators">
                        <div class="indicator" id="cwu-indicator" title="CWU Heating">
                            <span class="mdi mdi-water-boiler"></span>
                        </div>
                        <div class="indicator" id="floor-indicator" title="Floor Heating">
                            <span class="mdi mdi-heating-coil"></span>
                        </div>
                    </div>
                </div>
                <div class="state-display" id="state-display">
                    <div class="state-icon-container">
                        <span class="state-icon mdi mdi-loading mdi-spin"></span>
                        <div class="state-ring"></div>
                    </div>
                    <div class="state-info">
                        <h2 id="state-name">Loading...</h2>
                        <p id="state-description">Connecting to Home Assistant...</p>
                        <div class="state-meta">
                            <span id="state-time"><span class="mdi mdi-clock-outline"></span> --</span>
                            <span id="state-duration"><span class="mdi mdi-timer-outline"></span> --</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CWU Session Tracking Card - NEW -->
            <div class="card glass-effect cwu-session-card" id="cwu-session-card" style="display: none;">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-water-thermometer"></span>
                        CWU Heating Session
                    </span>
                    <span class="badge badge-info" id="session-status">Active</span>
                </div>
                <div class="session-content">
                    <div class="session-temps">
                        <div class="session-temp-item">
                            <span class="session-temp-label">Start</span>
                            <span class="session-temp-value" id="session-start-temp">--°C</span>
                        </div>
                        <div class="session-temp-arrow">
                            <span class="mdi mdi-arrow-right"></span>
                            <span class="session-temp-change" id="session-temp-change">+0.0°C</span>
                        </div>
                        <div class="session-temp-item">
                            <span class="session-temp-label">Current</span>
                            <span class="session-temp-value" id="session-current-temp">--°C</span>
                        </div>
                        <div class="session-temp-arrow">
                            <span class="mdi mdi-arrow-right-bold"></span>
                        </div>
                        <div class="session-temp-item target">
                            <span class="session-temp-label">Target</span>
                            <span class="session-temp-value" id="session-target-temp">45°C</span>
                        </div>
                    </div>
                    <div class="session-progress-container">
                        <div class="session-progress-bar">
                            <div class="session-progress-fill" id="session-progress-fill"></div>
                            <div class="session-progress-marker" id="session-progress-marker"></div>
                        </div>
                        <div class="session-progress-labels">
                            <span id="session-progress-start">35°C</span>
                            <span id="session-progress-percent">0%</span>
                            <span id="session-progress-end">45°C</span>
                        </div>
                    </div>
                    <div class="session-stats">
                        <div class="session-stat">
                            <span class="mdi mdi-clock-start"></span>
                            <span>Started: <strong id="session-start-time">--</strong></span>
                        </div>
                        <div class="session-stat">
                            <span class="mdi mdi-timer-sand"></span>
                            <span>Duration: <strong id="session-duration">--</strong></span>
                        </div>
                        <div class="session-stat">
                            <span class="mdi mdi-speedometer"></span>
                            <span>Rate: <strong id="session-rate">--</strong>°C/h</span>
                        </div>
                        <div class="session-stat">
                            <span class="mdi mdi-clock-end"></span>
                            <span>ETA: <strong id="session-eta">--</strong></span>
                        </div>
                        <div class="session-stat energy">
                            <span class="mdi mdi-lightning-bolt"></span>
                            <span>Energy: <strong id="session-energy">--</strong> kWh</span>
                        </div>
                    </div>
                    <div class="session-forecast">
                        <div class="forecast-item">
                            <span class="forecast-label">Estimated completion</span>
                            <span class="forecast-value" id="forecast-completion">--</span>
                        </div>
                        <div class="forecast-item">
                            <span class="forecast-label">Temp at session end (170min)</span>
                            <span class="forecast-value" id="forecast-temp-at-end">--°C</span>
                        </div>
                        <div class="forecast-item">
                            <span class="forecast-label">Sessions needed</span>
                            <span class="forecast-value" id="forecast-sessions">--</span>
                        </div>
                    </div>
                    <div class="session-comparison">
                        <span class="mdi mdi-history"></span>
                        <span>vs 1h ago: <strong id="session-vs-1h">--</strong></span>
                    </div>
                </div>
            </div>

            <!-- Temperatures Card -->
            <div class="card glass-effect">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-thermometer"></span>
                        Temperatures
                    </span>
                    <span class="badge" id="temp-status">OK</span>
                </div>
                <div class="temp-grid">
                    <div class="temp-item" id="temp-cwu" data-target="45">
                        <div class="temp-icon-wrapper">
                            <span class="icon mdi mdi-water-thermometer"></span>
                        </div>
                        <div class="temp-data">
                            <div class="label">CWU Water</div>
                            <div class="value">--<span class="unit">°C</span></div>
                            <div class="temp-bar"><div class="temp-bar-fill"></div></div>
                        </div>
                    </div>
                    <div class="temp-item" id="temp-salon" data-target="22">
                        <div class="temp-icon-wrapper">
                            <span class="icon mdi mdi-sofa"></span>
                        </div>
                        <div class="temp-data">
                            <div class="label">Living Room</div>
                            <div class="value">--<span class="unit">°C</span></div>
                            <div class="temp-bar"><div class="temp-bar-fill"></div></div>
                        </div>
                    </div>
                    <div class="temp-item" id="temp-bedroom" data-target="20">
                        <div class="temp-icon-wrapper">
                            <span class="icon mdi mdi-bed"></span>
                        </div>
                        <div class="temp-data">
                            <div class="label">Bedroom</div>
                            <div class="value">--<span class="unit">°C</span></div>
                            <div class="temp-bar"><div class="temp-bar-fill"></div></div>
                        </div>
                    </div>
                    <div class="temp-item" id="temp-kids" data-target="20">
                        <div class="temp-icon-wrapper">
                            <span class="icon mdi mdi-teddy-bear"></span>
                        </div>
                        <div class="temp-data">
                            <div class="label">Kids Room</div>
                            <div class="value">--<span class="unit">°C</span></div>
                            <div class="temp-bar"><div class="temp-bar-fill"></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Urgency Card -->
            <div class="card glass-effect">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-gauge"></span>
                        Urgency Levels
                    </span>
                </div>
                <div class="urgency-container">
                    <div class="urgency-item">
                        <div class="urgency-gauge">
                            <svg width="140" height="140" viewBox="0 0 140 140">
                                <circle class="bg" cx="70" cy="70" r="60"/>
                                <circle class="value" id="cwu-urgency-circle" cx="70" cy="70" r="60"
                                    stroke-dasharray="377" stroke-dashoffset="377"/>
                            </svg>
                            <div class="urgency-center">
                                <div class="urgency-value" id="cwu-urgency-value">0</div>
                                <div class="urgency-max">/4</div>
                            </div>
                        </div>
                        <div class="urgency-label">
                            <span class="mdi mdi-water-thermometer"></span>
                            CWU Urgency
                        </div>
                        <div class="urgency-level" id="cwu-urgency-level">None</div>
                    </div>
                    <div class="urgency-item">
                        <div class="urgency-gauge">
                            <svg width="140" height="140" viewBox="0 0 140 140">
                                <circle class="bg" cx="70" cy="70" r="60"/>
                                <circle class="value" id="floor-urgency-circle" cx="70" cy="70" r="60"
                                    stroke-dasharray="377" stroke-dashoffset="377"/>
                            </svg>
                            <div class="urgency-center">
                                <div class="urgency-value" id="floor-urgency-value">0</div>
                                <div class="urgency-max">/4</div>
                            </div>
                        </div>
                        <div class="urgency-label">
                            <span class="mdi mdi-home-thermometer"></span>
                            Floor Urgency
                        </div>
                        <div class="urgency-level" id="floor-urgency-level">None</div>
                    </div>
                </div>
            </div>

            <!-- Power Card - IMPROVED -->
            <div class="card glass-effect">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-flash"></span>
                        Power Consumption
                    </span>
                    <span class="badge" id="power-status">--</span>
                </div>
                <div class="power-display">
                    <div class="power-main">
                        <div class="power-value-wrapper">
                            <span class="power-value" id="power-value">--</span>
                            <span class="power-unit">W</span>
                        </div>
                        <div class="power-indicator" id="power-indicator">
                            <span class="mdi mdi-circle"></span>
                            <span id="power-status-text">Unknown</span>
                        </div>
                    </div>
                    <div class="power-bar-container">
                        <div class="power-bar-labels">
                            <span>0</span>
                            <span>1kW</span>
                            <span>2kW</span>
                            <span>3kW</span>
                            <span>4.5kW</span>
                        </div>
                        <div class="power-bar">
                            <div class="power-bar-fill" id="power-bar"></div>
                            <div class="power-threshold" style="left: 1.7%;" title="Pump working (80W)"></div>
                            <div class="power-threshold major" style="left: 33%;" title="CWU Heating (~1.5kW)"></div>
                            <div class="power-threshold major" style="left: 71%;" title="CWU Max (~3.2kW)"></div>
                        </div>
                    </div>
                    <div class="power-stats">
                        <div class="power-stat">
                            <span class="label">10min Avg</span>
                            <span class="value" id="power-avg">--</span>W
                        </div>
                        <div class="power-stat">
                            <span class="label">Peak (10m)</span>
                            <span class="value" id="power-peak">--</span>W
                        </div>
                        <div class="power-stat">
                            <span class="label">Cycle</span>
                            <span class="value" id="power-cycle-status">--</span>
                        </div>
                    </div>
                    <div class="power-cycle-info" id="power-cycle-info">
                        <span class="mdi mdi-information-outline"></span>
                        <span id="power-cycle-text">Pump works in cycles: peaks ~1.5kW with 6-7min intervals, 80W = pump circulating</span>
                    </div>
                </div>
            </div>

            <!-- CWU Cycle Timer -->
            <div class="card glass-effect">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-timer"></span>
                        CWU Heating Cycle
                    </span>
                    <span class="badge badge-info" id="cycle-status">Idle</span>
                </div>
                <div class="cycle-timer">
                    <div class="timer-circle">
                        <svg width="180" height="180" viewBox="0 0 180 180">
                            <defs>
                                <linearGradient id="timer-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#00d9ff"/>
                                    <stop offset="100%" style="stop-color:#4299e1"/>
                                </linearGradient>
                            </defs>
                            <circle class="bg" cx="90" cy="90" r="80"/>
                            <circle class="progress" id="cycle-progress" cx="90" cy="90" r="80"
                                stroke="url(#timer-gradient)"
                                stroke-dasharray="502" stroke-dashoffset="502"/>
                        </svg>
                        <div class="timer-text">
                            <div class="timer-value" id="cycle-time">0</div>
                            <div class="timer-label">minutes</div>
                            <div class="timer-max">of 170 max</div>
                        </div>
                    </div>
                    <div class="cycle-info">
                        <div class="cycle-stat">
                            <span class="mdi mdi-clock-end"></span>
                            <span>Remaining: <strong id="cycle-remaining">170</strong> min</span>
                        </div>
                        <div class="cycle-stat">
                            <span class="mdi mdi-percent"></span>
                            <span>Progress: <strong id="cycle-percent">0</strong>%</span>
                        </div>
                    </div>
                    <div class="cycle-warning" id="cycle-warning" style="display: none;">
                        <span class="mdi mdi-alert"></span>
                        Approaching 3h limit - pause coming soon!
                    </div>
                </div>
            </div>

            <!-- Temperature Chart - with fullscreen -->
            <div class="card glass-effect chart-card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-chart-line"></span>
                        Temperature History
                    </span>
                    <div class="chart-controls">
                        <button class="btn btn-sm" onclick="updateChartRange('tempChart', '1h')">1H</button>
                        <button class="btn btn-sm active" onclick="updateChartRange('tempChart', '6h')" id="temp-6h-btn">6H</button>
                        <button class="btn btn-sm" onclick="updateChartRange('tempChart', '24h')">24H</button>
                        <button class="btn btn-icon btn-sm" onclick="openFullscreenChart('temp')" title="Fullscreen">
                            <span class="mdi mdi-fullscreen"></span>
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="tempChart"></canvas>
                </div>
            </div>

            <!-- Power Chart - with fullscreen -->
            <div class="card glass-effect chart-card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-chart-areaspline"></span>
                        Power History
                    </span>
                    <div class="chart-controls">
                        <button class="btn btn-sm" onclick="updateChartRange('powerChart', '1h')">1H</button>
                        <button class="btn btn-sm active" onclick="updateChartRange('powerChart', '6h')" id="power-6h-btn">6H</button>
                        <button class="btn btn-sm" onclick="updateChartRange('powerChart', '24h')">24H</button>
                        <button class="btn btn-icon btn-sm" onclick="openFullscreenChart('power')" title="Fullscreen">
                            <span class="mdi mdi-fullscreen"></span>
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="powerChart"></canvas>
                </div>
            </div>

            <!-- Technical Temps Chart - NEW -->
            <div class="card glass-effect chart-card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-thermometer-lines"></span>
                        Technical Temperatures
                    </span>
                    <div class="chart-controls">
                        <button class="btn btn-sm" onclick="updateChartRange('techChart', '1h')">1H</button>
                        <button class="btn btn-sm active" onclick="updateChartRange('techChart', '6h')" id="tech-6h-btn">6H</button>
                        <button class="btn btn-sm" onclick="updateChartRange('techChart', '24h')">24H</button>
                        <button class="btn btn-icon btn-sm" onclick="openFullscreenChart('tech')" title="Fullscreen">
                            <span class="mdi mdi-fullscreen"></span>
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="techChart"></canvas>
                </div>
                <div class="chart-legend-custom">
                    <span class="legend-item"><span class="legend-color" style="background:#00d9ff"></span>CWU</span>
                    <span class="legend-item"><span class="legend-color" style="background:#fc8181"></span>Pump Inlet</span>
                    <span class="legend-item"><span class="legend-color" style="background:#68d391"></span>Pump Outlet</span>
                    <span class="legend-item"><span class="legend-color" style="background:#ed8936"></span>CWU Inlet</span>
                    <span class="legend-item"><span class="legend-color" style="background:#9f7aea"></span>Floor Inlet</span>
                </div>
            </div>

            <!-- Manual Controls -->
            <div class="card glass-effect">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-gamepad-variant"></span>
                        Manual Override
                    </span>
                </div>
                <div class="controls-grid">
                    <button class="control-btn cwu-btn" onclick="forceCWU(180)">
                        <span class="control-icon mdi mdi-water-boiler"></span>
                        <span class="control-label">Force CWU</span>
                        <span class="control-duration">3 Hours</span>
                    </button>
                    <button class="control-btn cwu-btn" onclick="forceCWU(360)">
                        <span class="control-icon mdi mdi-water-boiler-auto"></span>
                        <span class="control-label">Force CWU</span>
                        <span class="control-duration">6 Hours</span>
                    </button>
                    <button class="control-btn floor-btn" onclick="forceFloor(180)">
                        <span class="control-icon mdi mdi-heating-coil"></span>
                        <span class="control-label">Force Floor</span>
                        <span class="control-duration">3 Hours</span>
                    </button>
                    <button class="control-btn floor-btn" onclick="forceFloor(360)">
                        <span class="control-icon mdi mdi-home-thermometer"></span>
                        <span class="control-label">Force Floor</span>
                        <span class="control-duration">6 Hours</span>
                    </button>
                </div>
            </div>

            <!-- Test Actions -->
            <div class="card glass-effect">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-test-tube"></span>
                        Test Actions
                    </span>
                    <span class="badge badge-warning">Testing</span>
                </div>
                <p class="card-description">Test individual actions to verify integration works correctly.</p>
                <div class="test-grid">
                    <button class="test-btn test-cwu-on" onclick="testAction('cwu_on')">
                        <span class="mdi mdi-water-boiler"></span>
                        <span>CWU ON</span>
                    </button>
                    <button class="test-btn test-cwu-off" onclick="testAction('cwu_off')">
                        <span class="mdi mdi-water-boiler-off"></span>
                        <span>CWU OFF</span>
                    </button>
                    <button class="test-btn test-floor-on" onclick="testAction('floor_on')">
                        <span class="mdi mdi-heating-coil"></span>
                        <span>Floor ON</span>
                    </button>
                    <button class="test-btn test-floor-off" onclick="testAction('floor_off')">
                        <span class="mdi mdi-radiator-off"></span>
                        <span>Floor OFF</span>
                    </button>
                </div>
            </div>

            <!-- Heat Pump Status -->
            <div class="card glass-effect">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-heat-pump"></span>
                        System Status
                    </span>
                </div>
                <div class="system-status">
                    <div class="status-row">
                        <div class="status-item">
                            <span class="status-icon mdi mdi-water-boiler"></span>
                            <div class="status-info">
                                <span class="status-label">Water Heater</span>
                                <span class="status-value" id="wh-state">--</span>
                            </div>
                        </div>
                        <div class="status-item">
                            <span class="status-icon mdi mdi-heating-coil"></span>
                            <div class="status-info">
                                <span class="status-label">Floor Heating</span>
                                <span class="status-value" id="climate-state">--</span>
                            </div>
                        </div>
                    </div>
                    <div class="status-row">
                        <div class="status-item">
                            <span class="status-icon mdi mdi-hand-back-right"></span>
                            <div class="status-info">
                                <span class="status-label">Manual Override</span>
                                <span class="status-value" id="override-state">--</span>
                            </div>
                        </div>
                        <div class="status-item">
                            <span class="status-icon mdi mdi-connection"></span>
                            <div class="status-info">
                                <span class="status-label">Connection</span>
                                <span class="status-value" id="connection-state">Connected</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action History - with relative time and modal -->
            <div class="card glass-effect history-card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-history"></span>
                        Action History
                    </span>
                    <button class="btn btn-icon btn-sm" onclick="openHistoryModal('actions')" title="View All">
                        <span class="mdi mdi-arrow-expand"></span>
                    </button>
                </div>
                <div class="history-log" id="action-history">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Loading history...</span>
                    </div>
                </div>
            </div>

            <!-- State History Timeline - with relative time and modal -->
            <div class="card glass-effect history-card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-timeline-clock"></span>
                        State Timeline
                    </span>
                    <button class="btn btn-icon btn-sm" onclick="openHistoryModal('states')" title="View All">
                        <span class="mdi mdi-arrow-expand"></span>
                    </button>
                </div>
                <div class="timeline" id="state-history">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Loading timeline...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>CWU Controller v2.0.0 | Last update: <span id="last-update">--</span></p>
        </footer>
    </div>

    <!-- Fullscreen Chart Modal -->
    <div class="modal" id="chart-modal">
        <div class="modal-content modal-fullscreen">
            <div class="modal-header">
                <h3 id="chart-modal-title">Chart</h3>
                <div class="modal-controls">
                    <button class="btn btn-sm" onclick="updateModalChartRange('1h')">1H</button>
                    <button class="btn btn-sm" onclick="updateModalChartRange('6h')">6H</button>
                    <button class="btn btn-sm active" onclick="updateModalChartRange('24h')" id="modal-24h-btn">24H</button>
                    <button class="btn btn-sm" onclick="updateModalChartRange('48h')">48H</button>
                    <button class="btn btn-sm" onclick="updateModalChartRange('7d')">7D</button>
                    <button class="btn btn-icon" onclick="closeModal('chart-modal')">
                        <span class="mdi mdi-close"></span>
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <div class="chart-container-fullscreen">
                    <canvas id="modalChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal" id="history-modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="history-modal-title">History</h3>
                <button class="btn btn-icon" onclick="closeModal('history-modal')">
                    <span class="mdi mdi-close"></span>
                </button>
            </div>
            <div class="modal-body">
                <div class="history-full" id="history-modal-content">
                    <!-- Content loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <script src="panel.js?v=3.0.0"></script>
</body>
</html>
