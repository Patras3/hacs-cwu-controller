<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CWU Controller</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="stylesheet" href="styles.css?v=8.2.1">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-title">
                <div class="header-icon-wrapper">
                    <span class="mdi mdi-water-boiler"></span>
                    <div class="icon-pulse"></div>
                </div>
                <div>
                    <h1>CWU Controller</h1>
                    <p class="header-subtitle">Smart Heat Pump Management</p>
                </div>
            </div>
            <div class="header-status">
                <div class="status-badge" id="controller-status">
                    <span class="status-dot"></span>
                    <span class="status-text">Loading...</span>
                </div>
                <label class="toggle-switch" title="Enable/Disable Controller">
                    <input type="checkbox" id="controller-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
                <button class="btn btn-icon" onclick="refreshData()" title="Refresh Data">
                    <span class="mdi mdi-refresh"></span>
                </button>
            </div>
        </header>

        <!-- Alert for Fake Heating -->
        <div class="alert alert-danger animated" id="fake-heating-alert" style="display: none;">
            <span class="alert-icon mdi mdi-alert-circle mdi-spin"></span>
            <div>
                <strong>Fake Heating Detected!</strong>
                <p>Power is below 10W while water heater is active. The broken heater situation is detected.</p>
            </div>
            <button class="btn btn-sm" onclick="dismissAlert()">Dismiss</button>
        </div>

        <!-- Manual Override Alert -->
        <div class="alert alert-warning animated" id="override-alert" style="display: none;">
            <span class="alert-icon mdi mdi-hand-back-right"></span>
            <div>
                <strong>Manual Override Active</strong>
                <p>Automatic control is suspended. Override expires in: <span id="override-remaining">--</span></p>
            </div>
        </div>

        <!-- Quick Stats - Mobile First (no scroll needed) -->
        <div class="quick-stats">
            <!-- Power Widget -->
            <div class="quick-widget power-widget">
                <div class="quick-widget-icon">
                    <span class="mdi mdi-flash"></span>
                </div>
                <div class="quick-widget-content">
                    <span class="quick-widget-value" id="quick-power">--</span>
                    <span class="quick-widget-unit">W</span>
                </div>
                <div class="quick-widget-label">Power</div>
            </div>

            <!-- CWU Temp Widget with State Badge -->
            <div class="quick-widget temp-widget" id="quick-temp-widget">
                <div class="quick-widget-header">
                    <span class="quick-state-badge" id="quick-state-badge">
                        <span class="mdi mdi-sleep" id="quick-state-icon"></span>
                        <span id="quick-state-name">Idle</span>
                    </span>
                </div>
                <div class="quick-widget-content">
                    <span class="quick-widget-value" id="quick-cwu-temp">--</span>
                    <span class="quick-widget-unit">°C</span>
                    <span class="quick-temp-change" id="quick-temp-change"></span>
                </div>
                <div class="quick-widget-label">CWU Temp</div>
            </div>

            <!-- Mini Power Chart Widget -->
            <div class="quick-widget chart-widget">
                <div class="quick-widget-label">Power 1h</div>
                <div class="quick-chart-container">
                    <canvas id="quickPowerChart"></canvas>
                </div>
            </div>
        </div>

        <!-- BSB-LAN Heat Pump Status -->
        <div class="bsb-lan-card" id="bsb-lan-card">
            <div class="bsb-lan-header">
                <div class="bsb-lan-title">
                    <span class="mdi mdi-heat-pump"></span>
                    <span>BSB-LAN Heat Pump</span>
                </div>
                <div class="bsb-lan-controls">
                    <span class="bsb-lan-status" id="bsb-lan-status">
                        <span class="mdi mdi-loading mdi-spin"></span>
                    </span>
                    <button class="btn btn-icon btn-sm" onclick="refreshBsbLan()" title="Refresh BSB-LAN">
                        <span class="mdi mdi-refresh" id="bsb-refresh-icon"></span>
                    </button>
                </div>
            </div>
            <div class="bsb-lan-content" id="bsb-lan-content">
                <div class="bsb-loading">
                    <span class="mdi mdi-loading mdi-spin"></span>
                    <span>Connecting to BSB-LAN...</span>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Compact State Bar + Mode Control - Full Width -->
            <div class="card mode-control-card glass-effect">
                <div class="mode-control-row">
                    <!-- Current State (compact) -->
                    <div class="state-compact" id="state-compact">
                        <span class="state-icon-sm mdi mdi-loading mdi-spin" id="state-icon-sm"></span>
                        <span class="state-name-sm" id="state-name-sm">Loading...</span>
                        <span class="state-duration-sm" id="state-duration-sm">--</span>
                    </div>

                    <!-- Mode Control -->
                    <div class="mode-selector">
                        <button class="mode-btn mode-auto active" id="mode-btn-auto" onclick="setModeAuto()">
                            <span class="mdi mdi-autorenew"></span>
                            <span class="mode-label">AUTO</span>
                        </button>
                        <button class="mode-btn mode-cwu" id="mode-btn-cwu" onclick="openModeModal('cwu')">
                            <span class="mdi mdi-water-boiler"></span>
                            <span class="mode-label">CWU</span>
                            <span class="mode-duration" id="mode-cwu-duration"></span>
                        </button>
                        <button class="mode-btn mode-floor" id="mode-btn-floor" onclick="openModeModal('floor')">
                            <span class="mdi mdi-heating-coil"></span>
                            <span class="mode-label">FLOOR</span>
                            <span class="mode-duration" id="mode-floor-duration"></span>
                        </button>
                    </div>

                    <!-- Heating Indicators -->
                    <div class="heating-indicators">
                        <div class="indicator" id="cwu-indicator" title="CWU Heating">
                            <span class="mdi mdi-water-boiler"></span>
                        </div>
                        <div class="indicator" id="floor-indicator" title="Floor Heating">
                            <span class="mdi mdi-heating-coil"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Operating Mode & Tariff Card -->
            <div class="card glass-effect mode-tariff-card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-cog"></span>
                        Operating Mode
                    </span>
                    <span class="badge" id="tariff-status">--</span>
                </div>
                <div class="mode-tariff-content">
                    <div class="mode-selector-section">
                        <label for="operating-mode-select">Mode:</label>
                        <select id="operating-mode-select" class="mode-select" onchange="changeOperatingMode(this.value)">
                            <option value="broken_heater">Broken Heater</option>
                            <option value="winter">Winter</option>
                            <option value="summer">Summer (N/A)</option>
                        </select>
                    </div>
                    <div class="tariff-info">
                        <div class="tariff-row">
                            <span class="mdi mdi-currency-usd"></span>
                            <span>Current rate: <strong id="current-tariff-rate">--</strong> zł/kWh</span>
                        </div>
                        <div class="tariff-rates-config">
                            <div class="tariff-rate cheap">
                                <span class="mdi mdi-leaf"></span>
                                <span>Cheap: <strong id="tariff-cheap-rate">--</strong> zł</span>
                            </div>
                            <div class="tariff-rate expensive">
                                <span class="mdi mdi-fire"></span>
                                <span>Peak: <strong id="tariff-expensive-rate">--</strong> zł</span>
                            </div>
                        </div>
                        <div class="tariff-row" id="heating-window-row" style="display: none;">
                            <span class="mdi mdi-clock-check"></span>
                            <span id="heating-window-status">CWU heating window active</span>
                        </div>
                        <div class="tariff-row" id="winter-target-row" style="display: none;">
                            <span class="mdi mdi-target"></span>
                            <span>Winter target: <strong id="winter-cwu-target">--</strong>°C</span>
                        </div>
                        <div class="tariff-row" id="winter-emergency-row" style="display: none;">
                            <span class="mdi mdi-alert-circle-outline"></span>
                            <span>Emergency below: <strong id="winter-emergency-threshold">--</strong>°C</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Energy Consumption Card -->
            <div class="card glass-effect energy-card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-lightning-bolt"></span>
                        Energy Consumption
                    </span>
                </div>
                <div class="energy-content">
                    <div class="energy-period">
                        <h4>Today</h4>
                        <div class="energy-row">
                            <span class="energy-label"><span class="mdi mdi-water-boiler"></span> CWU:</span>
                            <span class="energy-value" id="energy-today-cwu">0.00 kWh</span>
                        </div>
                        <div class="energy-row sub">
                            <span class="energy-label energy-sub"><span class="mdi mdi-leaf"></span> Cheap:</span>
                            <span class="energy-value energy-cheap" id="energy-today-cwu-cheap">0.00 kWh</span>
                        </div>
                        <div class="energy-row sub">
                            <span class="energy-label energy-sub"><span class="mdi mdi-fire"></span> Peak:</span>
                            <span class="energy-value energy-expensive" id="energy-today-cwu-expensive">0.00 kWh</span>
                        </div>
                        <div class="energy-row">
                            <span class="energy-label"><span class="mdi mdi-heating-coil"></span> Floor:</span>
                            <span class="energy-value" id="energy-today-floor">0.00 kWh</span>
                        </div>
                        <div class="energy-row sub">
                            <span class="energy-label energy-sub"><span class="mdi mdi-leaf"></span> Cheap:</span>
                            <span class="energy-value energy-cheap" id="energy-today-floor-cheap">0.00 kWh</span>
                        </div>
                        <div class="energy-row sub">
                            <span class="energy-label energy-sub"><span class="mdi mdi-fire"></span> Peak:</span>
                            <span class="energy-value energy-expensive" id="energy-today-floor-expensive">0.00 kWh</span>
                        </div>
                        <div class="energy-row total">
                            <span class="energy-label">Total:</span>
                            <span class="energy-value" id="energy-today-total">0.00 kWh</span>
                        </div>
                        <div class="energy-row cost">
                            <span class="energy-label">Est. cost:</span>
                            <span class="energy-value" id="cost-today">~0.00 zł</span>
                        </div>
                        <div class="energy-row cost sub">
                            <span class="energy-label energy-sub"><span class="mdi mdi-water-boiler"></span> CWU:</span>
                            <span class="energy-value" id="cost-today-cwu">~0.00 zł</span>
                        </div>
                        <div class="energy-row cost sub">
                            <span class="energy-label energy-sub"><span class="mdi mdi-heating-coil"></span> Floor:</span>
                            <span class="energy-value" id="cost-today-floor">~0.00 zł</span>
                        </div>
                    </div>
                    <div class="energy-divider"></div>
                    <div class="energy-period">
                        <h4>Yesterday</h4>
                        <div class="energy-row">
                            <span class="energy-label"><span class="mdi mdi-water-boiler"></span> CWU:</span>
                            <span class="energy-value" id="energy-yesterday-cwu">0.00 kWh</span>
                        </div>
                        <div class="energy-row sub">
                            <span class="energy-label energy-sub"><span class="mdi mdi-leaf"></span> Cheap:</span>
                            <span class="energy-value energy-cheap" id="energy-yesterday-cwu-cheap">0.00 kWh</span>
                        </div>
                        <div class="energy-row sub">
                            <span class="energy-label energy-sub"><span class="mdi mdi-fire"></span> Peak:</span>
                            <span class="energy-value energy-expensive" id="energy-yesterday-cwu-expensive">0.00 kWh</span>
                        </div>
                        <div class="energy-row">
                            <span class="energy-label"><span class="mdi mdi-heating-coil"></span> Floor:</span>
                            <span class="energy-value" id="energy-yesterday-floor">0.00 kWh</span>
                        </div>
                        <div class="energy-row sub">
                            <span class="energy-label energy-sub"><span class="mdi mdi-leaf"></span> Cheap:</span>
                            <span class="energy-value energy-cheap" id="energy-yesterday-floor-cheap">0.00 kWh</span>
                        </div>
                        <div class="energy-row sub">
                            <span class="energy-label energy-sub"><span class="mdi mdi-fire"></span> Peak:</span>
                            <span class="energy-value energy-expensive" id="energy-yesterday-floor-expensive">0.00 kWh</span>
                        </div>
                        <div class="energy-row total">
                            <span class="energy-label">Total:</span>
                            <span class="energy-value" id="energy-yesterday-total">0.00 kWh</span>
                        </div>
                        <div class="energy-row cost">
                            <span class="energy-label">Est. cost:</span>
                            <span class="energy-value" id="cost-yesterday">~0.00 zł</span>
                        </div>
                        <div class="energy-row cost sub">
                            <span class="energy-label energy-sub"><span class="mdi mdi-water-boiler"></span> CWU:</span>
                            <span class="energy-value" id="cost-yesterday-cwu">~0.00 zł</span>
                        </div>
                        <div class="energy-row cost sub">
                            <span class="energy-label energy-sub"><span class="mdi mdi-heating-coil"></span> Floor:</span>
                            <span class="energy-value" id="cost-yesterday-floor">~0.00 zł</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CWU Session Tracking Card (with cycle info merged) -->
            <div class="card glass-effect cwu-session-card" id="cwu-session-card" style="display: none;">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-water-thermometer"></span>
                        CWU Heating Session
                    </span>
                    <span class="badge badge-info" id="session-status">Active</span>
                </div>
                <div class="session-content">
                    <div class="session-temps">
                        <div class="session-temp-item">
                            <span class="session-temp-label">Start</span>
                            <span class="session-temp-value" id="session-start-temp">--°C</span>
                        </div>
                        <div class="session-temp-arrow">
                            <span class="mdi mdi-arrow-right"></span>
                            <span class="session-temp-change" id="session-temp-change">+0.0°C</span>
                        </div>
                        <div class="session-temp-item">
                            <span class="session-temp-label">Current</span>
                            <span class="session-temp-value" id="session-current-temp">--°C</span>
                        </div>
                        <div class="session-temp-arrow">
                            <span class="mdi mdi-arrow-right-bold"></span>
                        </div>
                        <div class="session-temp-item target">
                            <span class="session-temp-label">Target</span>
                            <span class="session-temp-value" id="session-target-temp">45°C</span>
                        </div>
                    </div>
                    <div class="session-progress-container">
                        <div class="session-progress-bar">
                            <div class="session-progress-fill" id="session-progress-fill"></div>
                            <div class="session-progress-marker" id="session-progress-marker"></div>
                        </div>
                        <div class="session-progress-labels">
                            <span id="session-progress-start">35°C</span>
                            <span id="session-progress-percent">0%</span>
                            <span id="session-progress-end">45°C</span>
                        </div>
                    </div>
                    <div class="session-stats">
                        <div class="session-stat">
                            <span class="mdi mdi-clock-start"></span>
                            <span>Started: <strong id="session-start-time">--</strong></span>
                        </div>
                        <div class="session-stat">
                            <span class="mdi mdi-timer-sand"></span>
                            <span>Duration: <strong id="session-duration">--</strong></span>
                        </div>
                        <div class="session-stat">
                            <span class="mdi mdi-speedometer"></span>
                            <span>Rate: <strong id="session-rate">--</strong>°C/h</span>
                        </div>
                        <div class="session-stat">
                            <span class="mdi mdi-clock-end"></span>
                            <span>ETA: <strong id="session-eta">--</strong></span>
                        </div>
                        <div class="session-stat energy">
                            <span class="mdi mdi-lightning-bolt"></span>
                            <span>Energy: <strong id="session-energy">--</strong> kWh</span>
                        </div>
                    </div>
                    <div class="session-forecast">
                        <div class="forecast-item">
                            <span class="forecast-label">Estimated completion</span>
                            <span class="forecast-value" id="forecast-completion">--</span>
                        </div>
                        <div class="forecast-item">
                            <span class="forecast-label">Temp at session end (170min)</span>
                            <span class="forecast-value" id="forecast-temp-at-end">--°C</span>
                        </div>
                        <div class="forecast-item">
                            <span class="forecast-label">Sessions needed</span>
                            <span class="forecast-value" id="forecast-sessions">--</span>
                        </div>
                    </div>
                    <div class="session-comparison">
                        <span class="mdi mdi-history"></span>
                        <span>vs 1h ago: <strong id="session-vs-1h">--</strong></span>
                    </div>

                    <!-- Heat Pump Data (from BSB-LAN) -->
                    <div class="session-pump-data" id="session-pump-data">
                        <div class="pump-data-header">
                            <span class="mdi mdi-heat-pump"></span>
                            <span>Heat Pump</span>
                        </div>
                        <div class="pump-data-grid">
                            <div class="pump-data-item">
                                <span class="pump-label">CWU (pump)</span>
                                <span class="pump-value" id="session-pump-cwu">--°C</span>
                            </div>
                            <div class="pump-data-item">
                                <span class="pump-label">Flow</span>
                                <span class="pump-value" id="session-pump-flow">--°C</span>
                            </div>
                            <div class="pump-data-item">
                                <span class="pump-label">Return</span>
                                <span class="pump-value" id="session-pump-return">--°C</span>
                            </div>
                            <div class="pump-data-item delta">
                                <span class="pump-label">ΔT</span>
                                <span class="pump-value" id="session-pump-delta">--°C</span>
                            </div>
                        </div>
                    </div>

                    <!-- Cycle Timer (merged from separate card) -->
                    <div class="session-cycle">
                        <div class="cycle-mini">
                            <div class="cycle-progress-ring">
                                <svg width="60" height="60" viewBox="0 0 60 60">
                                    <circle class="bg" cx="30" cy="30" r="25" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="4"/>
                                    <circle class="progress" id="session-cycle-progress" cx="30" cy="30" r="25"
                                        fill="none" stroke="#00d9ff" stroke-width="4"
                                        stroke-dasharray="157" stroke-dashoffset="157"
                                        transform="rotate(-90 30 30)"/>
                                </svg>
                                <span class="cycle-mini-value" id="session-cycle-time">0</span>
                            </div>
                            <div class="cycle-mini-info">
                                <span class="cycle-mini-label">Cycle Time</span>
                                <span class="cycle-mini-remaining"><span id="session-cycle-remaining">170</span> min left (max 170)</span>
                            </div>
                        </div>
                        <div class="cycle-warning-mini" id="session-cycle-warning" style="display: none;">
                            <span class="mdi mdi-alert"></span>
                            <span>Pause coming soon!</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Temperatures Card -->
            <div class="card glass-effect">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-thermometer"></span>
                        Temperatures
                    </span>
                    <span class="badge" id="temp-status">OK</span>
                </div>
                <div class="temp-grid">
                    <div class="temp-item" id="temp-cwu" data-target="45">
                        <div class="temp-icon-wrapper">
                            <span class="icon mdi mdi-water-thermometer"></span>
                        </div>
                        <div class="temp-data">
                            <div class="label">CWU Water</div>
                            <div class="value">--<span class="unit">°C</span></div>
                            <div class="temp-bar"><div class="temp-bar-fill"></div></div>
                        </div>
                    </div>
                    <div class="temp-item" id="temp-salon" data-target="22">
                        <div class="temp-icon-wrapper">
                            <span class="icon mdi mdi-sofa"></span>
                        </div>
                        <div class="temp-data">
                            <div class="label">Living Room</div>
                            <div class="value">--<span class="unit">°C</span></div>
                            <div class="temp-bar"><div class="temp-bar-fill"></div></div>
                        </div>
                    </div>
                    <div class="temp-item" id="temp-bedroom" data-target="20">
                        <div class="temp-icon-wrapper">
                            <span class="icon mdi mdi-bed"></span>
                        </div>
                        <div class="temp-data">
                            <div class="label">Bedroom</div>
                            <div class="value">--<span class="unit">°C</span></div>
                            <div class="temp-bar"><div class="temp-bar-fill"></div></div>
                        </div>
                    </div>
                    <div class="temp-item" id="temp-kids" data-target="20">
                        <div class="temp-icon-wrapper">
                            <span class="icon mdi mdi-teddy-bear"></span>
                        </div>
                        <div class="temp-data">
                            <div class="label">Kids Room</div>
                            <div class="value">--<span class="unit">°C</span></div>
                            <div class="temp-bar"><div class="temp-bar-fill"></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Urgency Card -->
            <div class="card glass-effect">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-gauge"></span>
                        Urgency Levels
                    </span>
                </div>
                <div class="urgency-container">
                    <div class="urgency-item">
                        <div class="urgency-gauge">
                            <svg width="140" height="140" viewBox="0 0 140 140">
                                <circle class="bg" cx="70" cy="70" r="60"/>
                                <circle class="value" id="cwu-urgency-circle" cx="70" cy="70" r="60"
                                    stroke-dasharray="377" stroke-dashoffset="377"/>
                            </svg>
                            <div class="urgency-center">
                                <div class="urgency-value" id="cwu-urgency-value">0</div>
                                <div class="urgency-max">/4</div>
                            </div>
                        </div>
                        <div class="urgency-label">
                            <span class="mdi mdi-water-thermometer"></span>
                            CWU Urgency
                        </div>
                        <div class="urgency-level" id="cwu-urgency-level">None</div>
                    </div>
                    <div class="urgency-item">
                        <div class="urgency-gauge">
                            <svg width="140" height="140" viewBox="0 0 140 140">
                                <circle class="bg" cx="70" cy="70" r="60"/>
                                <circle class="value" id="floor-urgency-circle" cx="70" cy="70" r="60"
                                    stroke-dasharray="377" stroke-dashoffset="377"/>
                            </svg>
                            <div class="urgency-center">
                                <div class="urgency-value" id="floor-urgency-value">0</div>
                                <div class="urgency-max">/4</div>
                            </div>
                        </div>
                        <div class="urgency-label">
                            <span class="mdi mdi-home-thermometer"></span>
                            Floor Urgency
                        </div>
                        <div class="urgency-level" id="floor-urgency-level">None</div>
                    </div>
                </div>
            </div>

            <!-- Power Card - IMPROVED -->
            <div class="card glass-effect">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-flash"></span>
                        Power Consumption
                    </span>
                    <span class="badge" id="power-status">--</span>
                </div>
                <div class="power-display">
                    <div class="power-main">
                        <div class="power-value-wrapper">
                            <span class="power-value" id="power-value">--</span>
                            <span class="power-unit">W</span>
                        </div>
                        <div class="power-indicator" id="power-indicator">
                            <span class="mdi mdi-circle"></span>
                            <span id="power-status-text">Unknown</span>
                        </div>
                    </div>
                    <div class="power-bar-container">
                        <div class="power-bar-labels">
                            <span>0</span>
                            <span>1kW</span>
                            <span>2kW</span>
                            <span>3kW</span>
                            <span>4.5kW</span>
                        </div>
                        <div class="power-bar">
                            <div class="power-bar-fill" id="power-bar"></div>
                            <div class="power-threshold" style="left: 1.7%;" title="Pump working (80W)"></div>
                            <div class="power-threshold major" style="left: 33%;" title="CWU Heating (~1.5kW)"></div>
                            <div class="power-threshold major" style="left: 71%;" title="CWU Max (~3.2kW)"></div>
                        </div>
                    </div>
                    <div class="power-stats">
                        <div class="power-stat">
                            <span class="label">10min Avg</span>
                            <span class="value" id="power-avg">--</span>W
                        </div>
                        <div class="power-stat">
                            <span class="label">Peak (10m)</span>
                            <span class="value" id="power-peak">--</span>W
                        </div>
                        <div class="power-stat">
                            <span class="label">Cycle</span>
                            <span class="value" id="power-cycle-status">--</span>
                        </div>
                    </div>
                    <div class="power-cycle-info" id="power-cycle-info">
                        <span class="mdi mdi-information-outline"></span>
                        <span id="power-cycle-text">Pump works in cycles: peaks ~1.5kW with 6-7min intervals, 80W = pump circulating</span>
                    </div>
                </div>
            </div>

            <!-- Temperature Chart - with fullscreen -->
            <div class="card glass-effect chart-card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-chart-line"></span>
                        Temperature History
                    </span>
                    <div class="chart-controls">
                        <button class="btn btn-sm" onclick="updateChartRange('tempChart', '1h')">1H</button>
                        <button class="btn btn-sm active" onclick="updateChartRange('tempChart', '6h')" id="temp-6h-btn">6H</button>
                        <button class="btn btn-sm" onclick="updateChartRange('tempChart', '24h')">24H</button>
                        <button class="btn btn-icon btn-sm" onclick="openFullscreenChart('temp')" title="Fullscreen">
                            <span class="mdi mdi-fullscreen"></span>
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="tempChart"></canvas>
                </div>
            </div>

            <!-- Power Chart - with fullscreen -->
            <div class="card glass-effect chart-card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-chart-areaspline"></span>
                        Power History
                    </span>
                    <div class="chart-controls">
                        <button class="btn btn-sm" onclick="updateChartRange('powerChart', '1h')">1H</button>
                        <button class="btn btn-sm active" onclick="updateChartRange('powerChart', '6h')" id="power-6h-btn">6H</button>
                        <button class="btn btn-sm" onclick="updateChartRange('powerChart', '24h')">24H</button>
                        <button class="btn btn-icon btn-sm" onclick="openFullscreenChart('power')" title="Fullscreen">
                            <span class="mdi mdi-fullscreen"></span>
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="powerChart"></canvas>
                </div>
            </div>

            <!-- Technical Temps Chart (BSB-LAN) -->
            <div class="card glass-effect chart-card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-thermometer-lines"></span>
                        Heat Pump Temps (BSB-LAN)
                    </span>
                    <div class="chart-controls">
                        <button class="btn btn-sm" onclick="updateChartRange('techChart', '1h')">1H</button>
                        <button class="btn btn-sm active" onclick="updateChartRange('techChart', '6h')" id="tech-6h-btn">6H</button>
                        <button class="btn btn-sm" onclick="updateChartRange('techChart', '24h')">24H</button>
                        <button class="btn btn-icon btn-sm" onclick="openFullscreenChart('tech')" title="Fullscreen">
                            <span class="mdi mdi-fullscreen"></span>
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="techChart"></canvas>
                </div>
                <div class="chart-legend-custom">
                    <span class="legend-item"><span class="legend-color" style="background:#00d9ff"></span>CWU</span>
                    <span class="legend-item"><span class="legend-color" style="background:#fc8181"></span>Flow</span>
                    <span class="legend-item"><span class="legend-color" style="background:#68d391"></span>Return</span>
                    <span class="legend-item"><span class="legend-color" style="background:#f6e05e"></span>ΔT</span>
                </div>
            </div>

            <!-- Outside Temperature Chart -->
            <div class="card glass-effect chart-card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-weather-partly-cloudy"></span>
                        Outside Temperature
                    </span>
                    <div class="chart-controls">
                        <button class="btn btn-sm" onclick="updateChartRange('outsideChart', '6h')">6H</button>
                        <button class="btn btn-sm active" onclick="updateChartRange('outsideChart', '24h')" id="outside-24h-btn">24H</button>
                        <button class="btn btn-sm" onclick="updateChartRange('outsideChart', '48h')">48H</button>
                        <button class="btn btn-sm" onclick="updateChartRange('outsideChart', '7d')">7D</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="outsideChart"></canvas>
                </div>
            </div>

            <!-- Test Actions -->
            <div class="card glass-effect">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-test-tube"></span>
                        Test Actions
                    </span>
                    <span class="badge badge-warning">Testing</span>
                </div>
                <p class="card-description">Test individual actions to verify integration works correctly.</p>
                <div class="test-grid">
                    <button class="test-btn test-cwu-on" onclick="testAction('cwu_on')">
                        <span class="mdi mdi-water-boiler"></span>
                        <span>CWU ON</span>
                    </button>
                    <button class="test-btn test-cwu-off" onclick="testAction('cwu_off')">
                        <span class="mdi mdi-water-boiler-off"></span>
                        <span>CWU OFF</span>
                    </button>
                    <button class="test-btn test-floor-on" onclick="testAction('floor_on')">
                        <span class="mdi mdi-heating-coil"></span>
                        <span>Floor ON</span>
                    </button>
                    <button class="test-btn test-floor-off" onclick="testAction('floor_off')">
                        <span class="mdi mdi-radiator-off"></span>
                        <span>Floor OFF</span>
                    </button>
                </div>
            </div>

            <!-- Heat Pump Status -->
            <div class="card glass-effect">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-heat-pump"></span>
                        System Status
                    </span>
                </div>
                <div class="system-status">
                    <div class="status-row">
                        <div class="status-item">
                            <span class="status-icon mdi mdi-water-boiler"></span>
                            <div class="status-info">
                                <span class="status-label">CWU Mode (BSB)</span>
                                <span class="status-value" id="wh-state">--</span>
                            </div>
                        </div>
                        <div class="status-item">
                            <span class="status-icon mdi mdi-heating-coil"></span>
                            <div class="status-info">
                                <span class="status-label">Floor Mode (BSB)</span>
                                <span class="status-value" id="climate-state">--</span>
                            </div>
                        </div>
                    </div>
                    <div class="status-row">
                        <div class="status-item">
                            <span class="status-icon mdi mdi-hand-back-right"></span>
                            <div class="status-info">
                                <span class="status-label">Manual Override</span>
                                <span class="status-value" id="override-state">--</span>
                            </div>
                        </div>
                        <div class="status-item">
                            <span class="status-icon mdi mdi-connection"></span>
                            <div class="status-info">
                                <span class="status-label">Connection</span>
                                <span class="status-value" id="connection-state">Connected</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action History - with relative time and modal -->
            <div class="card glass-effect history-card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-history"></span>
                        Action History
                    </span>
                    <button class="btn btn-icon btn-sm" onclick="openHistoryModal('actions')" title="View All">
                        <span class="mdi mdi-arrow-expand"></span>
                    </button>
                </div>
                <div class="history-log" id="action-history">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Loading history...</span>
                    </div>
                </div>
            </div>

            <!-- State History Timeline - with relative time and modal -->
            <div class="card glass-effect history-card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="icon mdi mdi-timeline-clock"></span>
                        State Timeline
                    </span>
                    <button class="btn btn-icon btn-sm" onclick="openHistoryModal('states')" title="View All">
                        <span class="mdi mdi-arrow-expand"></span>
                    </button>
                </div>
                <div class="timeline" id="state-history">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Loading timeline...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>CWU Controller v3.0.0 | Last update: <span id="last-update">--</span></p>
        </footer>
    </div>

    <!-- Fullscreen Chart Modal -->
    <div class="modal" id="chart-modal">
        <div class="modal-content modal-fullscreen">
            <div class="modal-header">
                <h3 id="chart-modal-title">Chart</h3>
                <div class="modal-controls">
                    <button class="btn btn-sm" onclick="updateModalChartRange('1h')">1H</button>
                    <button class="btn btn-sm" onclick="updateModalChartRange('6h')">6H</button>
                    <button class="btn btn-sm active" onclick="updateModalChartRange('24h')" id="modal-24h-btn">24H</button>
                    <button class="btn btn-sm" onclick="updateModalChartRange('48h')">48H</button>
                    <button class="btn btn-sm" onclick="updateModalChartRange('7d')">7D</button>
                    <button class="btn btn-icon" onclick="closeModal('chart-modal')">
                        <span class="mdi mdi-close"></span>
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <div class="chart-container-fullscreen">
                    <canvas id="modalChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal" id="history-modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="history-modal-title">History</h3>
                <button class="btn btn-icon" onclick="closeModal('history-modal')">
                    <span class="mdi mdi-close"></span>
                </button>
            </div>
            <div class="modal-body">
                <div class="history-full" id="history-modal-content">
                    <!-- Content loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Mode Selection Modal -->
    <div class="modal" id="mode-modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h3 id="mode-modal-title">Select Duration</h3>
                <button class="btn btn-icon" onclick="closeModal('mode-modal')">
                    <span class="mdi mdi-close"></span>
                </button>
            </div>
            <div class="modal-body">
                <div class="mode-modal-icon" id="mode-modal-icon">
                    <span class="mdi mdi-water-boiler"></span>
                </div>

                <!-- Tabs (only visible for CWU) -->
                <div class="mode-tabs" id="mode-tabs">
                    <button class="mode-tab active" id="tab-duration" onclick="switchModeTab('duration')">
                        <span class="mdi mdi-timer-outline"></span> Duration
                    </button>
                    <button class="mode-tab" id="tab-heat-to" onclick="switchModeTab('heat-to')">
                        <span class="mdi mdi-target"></span> Heat to °C
                    </button>
                </div>

                <!-- Duration Panel -->
                <div class="mode-panel" id="panel-duration">
                    <p class="mode-modal-description" id="mode-modal-description">Force CWU heating for:</p>
                    <div class="duration-slider-container">
                        <input type="range" id="duration-slider" min="1" max="12" step="0.5" value="3"
                               oninput="updateDurationDisplay()">
                        <div class="duration-display">
                            <span class="duration-value" id="duration-value">3</span>
                            <span class="duration-unit">hours</span>
                        </div>
                    </div>
                    <div class="duration-presets">
                        <button class="preset-btn" onclick="setDuration(1)">1h</button>
                        <button class="preset-btn" onclick="setDuration(2)">2h</button>
                        <button class="preset-btn active" onclick="setDuration(3)">3h</button>
                        <button class="preset-btn" onclick="setDuration(6)">6h</button>
                        <button class="preset-btn" onclick="setDuration(12)">12h</button>
                    </div>
                </div>

                <!-- Heat-to Panel (CWU only) -->
                <div class="mode-panel" id="panel-heat-to" style="display: none;">
                    <p class="mode-modal-description">Heat CWU to target temperature, then return to AUTO:</p>
                    <div class="heat-to-input-group">
                        <input type="number" id="heat-to-temp" class="heat-to-input" value="50" min="36" max="55" step="1">
                        <span class="heat-to-unit">°C</span>
                    </div>
                    <div class="heat-to-presets">
                        <button class="preset-btn" onclick="setHeatToTemp(40)">40°C</button>
                        <button class="preset-btn" onclick="setHeatToTemp(45)">45°C</button>
                        <button class="preset-btn active" onclick="setHeatToTemp(50)">50°C</button>
                        <button class="preset-btn" onclick="setHeatToTemp(55)">55°C</button>
                    </div>
                </div>

                <!-- Heat-to progress (shown when active) -->
                <div class="heat-to-progress" id="heat-to-progress" style="display: none;">
                    <div class="heat-to-progress-bar">
                        <div class="heat-to-progress-fill" id="heat-to-progress-fill"></div>
                    </div>
                    <span class="heat-to-progress-text" id="heat-to-progress-text">--°C / --°C</span>
                </div>

                <button class="btn btn-primary btn-block" id="mode-confirm-btn" onclick="confirmMode()">
                    <span class="mdi mdi-check"></span>
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <script src="panel.js?v=8.2.1"></script>
</body>
</html>
